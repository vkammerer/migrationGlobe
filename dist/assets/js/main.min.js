"use strict";!function(){var e={};e.vertex1="\n		varying vec2 vUv;\n\n		void main() {\n			vUv = uv;\n			gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n		}\n	",e.fragment1="\n		uniform vec3 color;\n		uniform sampler2D texture;\n		uniform float displacement;\n		varying vec2 vUv;\n\n		void main() {\n			vec4 texColor = texture2D(texture, vec2(vUv.x+displacement, vUv.y));\n			gl_FragColor = texColor*vec4(color,1.0);\n		}\n	",window.Shaders=e}(),function(){var e={};e.xyzToLatLon=function(e,t){var n=90-180*Math.acos(e.y/t.geometry.radius)/Math.PI,o=90+180*Math.atan2(e.x,e.z)/Math.PI%360;return{lat:n,lon:o}},e.latLonToXyz=function(e,t,n){var o=(90-e)*Math.PI/180,r=(180-t)*Math.PI/180,i=new THREE.Vector3;return i.x=n.geometry.radius*Math.sin(o)*Math.cos(r),i.y=n.geometry.radius*Math.cos(o),i.z=n.geometry.radius*Math.sin(o)*Math.sin(r),i.add(n.position),i},e.getCountryCodeFromOSM=function(e,t,n){var o="http://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&zoom=6",r=o+"&lat="+e+"&lon="+t,i=new XMLHttpRequest;i.open("GET",r,!0),i.onreadystatechange=function(){if(4===i.readyState&&200===i.status){var e=JSON.parse(i.responseText);if(e.address&&(e.address.country||e.address.country_code)){var t=e.address.country||e.address.country_code;n(t)}else n(null)}},i.send(null)},e.getCountryCodeFromIndex=function(e,t){var n=new XMLHttpRequest;n.open("GET","assets/data/indexed_countries.json",!0),n.onreadystatechange=function(){if(4===n.readyState&&200===n.status){var o=JSON.parse(n.responseText);t(o[e-1])}},e>0?n.send(null):t(null)},e.geoJsonToGeometry=function(e,t){var n,o=new THREE.Geometry;if("Polygon"===e.geometry.type)n=e.geometry.coordinates,this.computePolygon(n,o,t);else if("MultiPolygon"===e.geometry.type)for(var r=e.geometry.coordinates,i=0;i<r.length;i++)n=r[i],this.computePolygon(n,o,t);return o},e.computePolygon=function(e,t,n){for(var o=0;o<e.length;o++)for(var r=e[o],i=0;i<r.length;i++){var a=r[i],s=this.latLonToXyz(a[1],a[0],n);t.vertices.push(s),0!==i&&i!==r.length-1&&t.vertices.push(s)}},window.GeoUtils=e}(),function(){var e=function(e){e=e||{};var t=e.radius||200,n=e.widthSegments||40,o=e.heightSegments||30,r=e.texture||"assets/img/world.jpg",i=THREE.ImageUtils.loadTexture(r),a=e.material||new THREE.MeshBasicMaterial({map:i}),s=new THREE.SphereGeometry(t,n,o),l=new THREE.Mesh(s,a);return l.rotation.y=Math.PI,l};window.Globe=e}(),function(){var e=function(e,t){this.mesh=e,this.numberOfPoints=t};e.prototype.quadraticFlux=function(e,t,n,o){var r=GeoUtils.latLonToXyz(e,t,this.mesh),i=GeoUtils.latLonToXyz(n,o,this.mesh),a=r.clone().sub(i).length(),s=r.clone().add(i).multiplyScalar(.5);s.sub(this.mesh.position),s.normalize(),s.multiplyScalar(this.mesh.geometry.radius+.7*a),s.add(this.mesh.position);var l=new THREE.QuadraticBezierCurve3(r,s,i),d=new THREE.CurvePath;d.add(l);var u=d.createPointsGeometry(this.numberOfPoints);return u},e.prototype.cubicFlux=function(e,t,n,o){var r=GeoUtils.latLonToXyz(e,t,this.mesh),i=GeoUtils.latLonToXyz(n,o,this.mesh),a=r.clone().sub(i).length(),s=r.clone().sub(this.mesh.position);s.normalize(),s.multiplyScalar(a),s.add(r);var l=i.clone().sub(this.mesh.position);l.normalize(),l.multiplyScalar(a),l.add(i);var d=new THREE.CubicBezierCurve3(r,s,l,i),u=new THREE.CurvePath;u.add(d);var c=u.createPointsGeometry(this.numberOfPoints);return c},e.prototype.doubleCubicFlux=function(e,t,n,o){var r=GeoUtils.latLonToXyz(e,t,this.mesh),i=GeoUtils.latLonToXyz(n,o,this.mesh),a=r.clone().sub(i).length(),s=r.clone().add(i).multiplyScalar(.5);s.sub(this.mesh.position),s.normalize(),s.multiplyScalar(this.mesh.geometry.radius+.2*a),s.add(this.mesh.position);var l=r.clone().sub(i);l.normalize();var d=s.clone().add(l.clone().multiplyScalar(a/2)),u=s.clone().add(l.clone().multiplyScalar(-a/2)),c=new THREE.CubicBezierCurve3(r,r,d,s),m=new THREE.CubicBezierCurve3(s,u,i,i),h=c.getPoints(this.numberOfPoints/2);h=h.splice(0,h.length-1),h=h.concat(m.getPoints(this.numberOfPoints/2));var p=new THREE.Geometry;return p.vertices=h,p},window.Flux=e}(),function(){function e(){l=document.getElementById("container"),v=window.innerWidth,E=window.innerHeight,m=new THREE.Scene,m.fog=new THREE.Fog(1118481,1800,2e3),u=new THREE.PerspectiveCamera(45,v/E,1,2e3),u.position.z=1500,u.lookAt(m.position),c=new THREE.OrbitControls(u),c.minDistance=500,c.maxDistance=2e3,c.addEventListener("change",a),d=new Stats,document.body.appendChild(d.domElement);var e=new dat.GUI;e.add(H,"speed",.001,.03),e.addColor(H,"color"),h=new THREE.WebGLRenderer({antialias:!0}),h.setSize(v,E),h.domElement.style.position="absolute",l.appendChild(h.domElement),window.addEventListener("resize",n,!1),document.addEventListener("mousedown",r,!1),p=new Globe({texture:"assets/img/world_4k.jpg",radius:300}),m.add(p),t();var o=new THREE.AxisHelper(2*p.geometry.radius);m.add(o);var i=50,s=new Flux(p,i),g=THREE.ImageUtils.loadTexture("assets/img/texture.16.png");g.wrapS=THREE.RepeatWrapping,g.wrapT=THREE.RepeatWrapping,f={color:{type:"c",value:new THREE.Color(16711680)},texture:{type:"t",value:g},displacement:{type:"f",value:0}};var w=new THREE.ShaderMaterial({uniforms:f,vertexShader:Shaders.vertex1,fragmentShader:Shaders.fragment1,blending:THREE.AdditiveBlending,depthTest:!0,depthWrite:!1,transparent:!0,linewidth:1}),y={latitude:47.21176,longitude:-1.573},T=new XMLHttpRequest;T.open("GET","assets/data/capitals.json",!0),T.onreadystatechange=function(){if(4===T.readyState&&200===T.status)for(var e,t=JSON.parse(T.responseText),n=0;n<t.length;n++){e=t[n];var o=s.doubleCubicFlux(y.latitude,y.longitude,e.latitude,e.longitude),r=new THREE.Line(o,w);m.add(r)}},T.send(null)}function t(){w=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0}),w.setSize(v,E),g=new THREE.Scene,y=new Globe({texture:"assets/img/indexed_map.png",radius:300}),g.add(y)}function n(){u.aspect=window.innerWidth/window.innerHeight,u.updateProjectionMatrix(),h.setSize(window.innerWidth,window.innerHeight),w.setSize(window.innerWidth,window.innerHeight),a()}function o(e){var t=w.context;t.preserveDrawingBuffer=!0;var n=Math.floor(e.clientX),o=Math.floor(t.canvas.height-e.clientY),r=new Uint8Array(4);return t.readPixels(n,o,1,1,t.RGBA,t.UNSIGNED_BYTE,r),t.preserveDrawingBuffer=!1,r[0]}function r(e){var t=h.context,n=e.clientX/t.canvas.clientWidth*2-1,r=2*-(e.clientY/t.canvas.clientHeight)+1,i=new THREE.Vector3(n,r,u.near),a=new THREE.Projector;a.unprojectVector(i,u);var s=new THREE.Raycaster(u.position,i.sub(u.position).normalize()),l=s.intersectObject(p,!0);if(l.length>0){var d=l[0].point,c=o(e);GeoUtils.getCountryCodeFromIndex(c,function(e){console.log(e)});var v=new THREE.CubeGeometry(1,1,1),E=new THREE.MeshBasicMaterial({color:"red"}),g=new THREE.Mesh(v,E);g.position=d,m.add(g)}}function i(){requestAnimationFrame(i),a(),d.update(),c.update()}function a(){f.displacement.value+=H.speed,f.color.value=new THREE.Color(H.color),h.render(m,u),w.render(g,u)}function s(){var e=new THREE.Geometry,t=new THREE.LineBasicMaterial({color:"red",linewidth:1}),n=new XMLHttpRequest;n.open("GET","assets/data/countries.geo.json",!0),n.onreadystatechange=function(){if(4===n.readyState&&200===n.status){for(var o=JSON.parse(n.responseText),r=o.features,i=0;i<r.length;i++){var a=r[i],s=GeoUtils.geoJsonToGeometry(a,p);THREE.GeometryUtils.merge(e,s),console.log(i+" : added "+a.properties.name+" : "+a.geometry.type)}var l=new THREE.Line(e,t,THREE.LinePieces);m.add(l)}},n.send(null)}Detector.webgl||Detector.addGetWebGLMessage();var l,d,u,c,m,h,p,v,E,g,w,y,f,T=function(){this.speed=.004,this.color="#121314"},H=new T;e(),i(),s()}();