"use strict";!function(){var e={};e.vertex1="\n		varying vec2 vUv;\n\n		void main() {\n			vUv = uv;\n			gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n		}\n	",e.fragment1="\n		uniform vec3 color;\n		uniform sampler2D texture;\n		uniform float displacement;\n		varying vec2 vUv;\n\n		void main() {\n			vec4 texColor = texture2D(texture, vec2(vUv.x+displacement, vUv.y));\n			gl_FragColor = texColor*vec4(color,1.0);\n		}\n	",e.globeFragment="\n		uniform sampler2D texture;\n		uniform sampler2D index;\n		uniform float clicked;\n		varying vec2 vUv;\n\n		void main() {\n			vec4 currentTexture = texture2D(texture, vUv);\n			vec4 currentIndex = texture2D(index, vUv);\n			float fader = 0.0;\n			if (clicked/currentIndex.r == 1.0) fader = 1.0;\n			gl_FragColor = mix(currentTexture, currentIndex*255.0, fader);\n		}\n	",window.Shaders=e}(),function(){var e={};e.xyzToLatLon=function(e,t){var n=90-180*Math.acos(e.y/t.geometry.radius)/Math.PI,o=90+180*Math.atan2(e.x,e.z)/Math.PI%360;return{lat:n,lon:o}},e.latLonToXyz=function(e,t,n){var o=(90-e)*Math.PI/180,a=(180-t)*Math.PI/180,r=new THREE.Vector3;return r.x=n.geometry.radius*Math.sin(o)*Math.cos(a),r.y=n.geometry.radius*Math.cos(o),r.z=n.geometry.radius*Math.sin(o)*Math.sin(a),r.add(n.position),r},e.getIndex=function(t,n,o){var a=new Image;a.src="assets/img/indexed_map.png",a.onload=function(){var r=e.xyzToLatLon(t,n),i=Math.floor(r.lon/360*a.width+a.width/2),s=Math.floor(-r.lat/360*a.width+a.height/2);i>a.width&&(i-=a.width),s>a.height&&(s-=a.height);var l=document.createElement("canvas");l.width=a.width,l.height=a.height,l.getContext("2d").drawImage(a,0,0,a.width,a.height);var d=l.getContext("2d").getImageData(i,s,1,1).data;o(d[0])}},e.getCountryCodeFromIndex=function(e,t){var n=new XMLHttpRequest;n.open("GET","assets/data/indexed_countries.json",!0),n.onreadystatechange=function(){if(4===n.readyState&&200===n.status){var o=JSON.parse(n.responseText);t(o[e-1])}},e>0?n.send(null):t(null)},e.geoJsonToGeometry=function(t,n){var o,a=new THREE.Geometry;if("Polygon"===t.geometry.type)o=t.geometry.coordinates,e.computePolygon(o,a,n);else if("MultiPolygon"===t.geometry.type)for(var r=t.geometry.coordinates,i=0;i<r.length;i++)o=r[i],e.computePolygon(o,a,n);return a},e.computePolygon=function(t,n,o){for(var a=0;a<t.length;a++)for(var r=t[a],i=0;i<r.length;i++){var s=r[i],l=e.latLonToXyz(s[1],s[0],o);n.vertices.push(l),0!==i&&i!==r.length-1&&n.vertices.push(l)}},window.GeoUtils=e}(),function(){var e=function(e){e=e||{};var t=e.radius||200,n=e.widthSegments||40,o=e.heightSegments||30,a=e.texture||"assets/img/world.jpg",r=THREE.ImageUtils.loadTexture(a),i=e.material||new THREE.MeshBasicMaterial({map:r}),s=new THREE.SphereGeometry(t,n,o),l=new THREE.Mesh(s,i);return l.rotation.y=Math.PI,l};window.Globe=e}(),function(){var e=function(e,t){this.mesh=e,this.numberOfPoints=t||50};e.prototype.quadraticFlux=function(e,t,n,o){var a=GeoUtils.latLonToXyz(e,t,this.mesh),r=GeoUtils.latLonToXyz(n,o,this.mesh),i=a.clone().sub(r).length(),s=a.clone().add(r).multiplyScalar(.5);s.sub(this.mesh.position),s.normalize(),s.multiplyScalar(this.mesh.geometry.radius+.7*i),s.add(this.mesh.position);var l=new THREE.QuadraticBezierCurve3(a,s,r),d=new THREE.CurvePath;d.add(l);var u=d.createPointsGeometry(this.numberOfPoints);return u},e.prototype.cubicFlux=function(e,t,n,o){var a=GeoUtils.latLonToXyz(e,t,this.mesh),r=GeoUtils.latLonToXyz(n,o,this.mesh),i=a.clone().sub(r).length(),s=a.clone().sub(this.mesh.position);s.normalize(),s.multiplyScalar(i),s.add(a);var l=r.clone().sub(this.mesh.position);l.normalize(),l.multiplyScalar(i),l.add(r);var d=new THREE.CubicBezierCurve3(a,s,l,r),u=new THREE.CurvePath;u.add(d);var c=u.createPointsGeometry(this.numberOfPoints);return c},e.prototype.doubleCubicFlux=function(e,t,n,o){var a=GeoUtils.latLonToXyz(e,t,this.mesh),r=GeoUtils.latLonToXyz(n,o,this.mesh),i=a.clone().sub(r).length(),s=a.clone().add(r).multiplyScalar(.5);s.sub(this.mesh.position),s.normalize(),s.multiplyScalar(this.mesh.geometry.radius+.2*i),s.add(this.mesh.position);var l=a.clone().sub(r);l.normalize();var d=s.clone().add(l.clone().multiplyScalar(i/2)),u=s.clone().add(l.clone().multiplyScalar(-i/2)),c=new THREE.CubicBezierCurve3(a,a,d,s),m=new THREE.CubicBezierCurve3(s,u,r,r),h=c.getPoints(this.numberOfPoints/2);h=h.splice(0,h.length-1),h=h.concat(m.getPoints(this.numberOfPoints/2));var v=new THREE.Geometry;return v.vertices=h,v},window.Flux=e}(),function(){function e(){i=document.getElementById("container"),h=window.innerWidth,v=window.innerHeight,u=new THREE.Scene,u.fog=new THREE.Fog(1118481,1800,2e3),l=new THREE.PerspectiveCamera(45,h/v,1,2e3),l.position.z=1500,l.lookAt(u.position),d=new THREE.OrbitControls(l),d.minDistance=500,d.maxDistance=2e3,d.addEventListener("change",a),s=new Stats,document.body.appendChild(s.domElement);var e=new dat.GUI;e.add(w,"speed",.001,.03),e.addColor(w,"color"),c=new THREE.WebGLRenderer({antialias:!1}),c.setSize(h,v),c.domElement.style.position="absolute",i.appendChild(c.domElement),window.addEventListener("resize",t,!1),document.addEventListener("mousedown",n,!1),g={texture:{type:"t",value:THREE.ImageUtils.loadTexture("assets/img/world_4k.jpg")},index:{type:"t",value:THREE.ImageUtils.loadTexture("assets/img/indexed_map.png")},clicked:{type:"f",value:1}};var o=new THREE.ShaderMaterial({uniforms:g,vertexShader:Shaders.vertex1,fragmentShader:Shaders.globeFragment});m=new Globe({texture:"assets/img/world_4k.jpg",radius:300,material:o}),u.add(m);var r=new THREE.AxisHelper(2*m.geometry.radius);u.add(r);var E=50,y=new Flux(m,E),f=THREE.ImageUtils.loadTexture("assets/img/texture.16.png");f.wrapS=THREE.RepeatWrapping,f.wrapT=THREE.RepeatWrapping,p={color:{type:"c",value:new THREE.Color(16711680)},texture:{type:"t",value:f},displacement:{type:"f",value:0}};var T=new THREE.ShaderMaterial({uniforms:p,vertexShader:Shaders.vertex1,fragmentShader:Shaders.fragment1,blending:THREE.AdditiveBlending,depthTest:!0,depthWrite:!1,transparent:!0,linewidth:1}),x={latitude:47.21176,longitude:-1.573},H=new XMLHttpRequest;H.open("GET","assets/data/capitals.json",!0),H.onreadystatechange=function(){if(4===H.readyState&&200===H.status)for(var e,t=JSON.parse(H.responseText),n=0;n<t.length;n++){e=t[n];var o=y.doubleCubicFlux(x.latitude,x.longitude,e.latitude,e.longitude),a=new THREE.Line(o,T);u.add(a)}},H.send(null)}function t(){l.aspect=window.innerWidth/window.innerHeight,l.updateProjectionMatrix(),c.setSize(window.innerWidth,window.innerHeight),a()}function n(e){var t=c.context,n=e.clientX/t.canvas.clientWidth*2-1,o=2*-(e.clientY/t.canvas.clientHeight)+1,a=new THREE.Vector3(n,o,l.near),r=new THREE.Projector;r.unprojectVector(a,l);var i=new THREE.Raycaster(l.position,a.sub(l.position).normalize()),s=i.intersectObject(m,!0);if(s.length>0){var d=s[0].point;GeoUtils.getIndex(d,m,function(e){console.log(e),g.clicked.value=e/255,GeoUtils.getCountryCodeFromIndex(e,function(e){console.log(e)})});var h=new THREE.CubeGeometry(1,1,1),v=new THREE.MeshBasicMaterial({color:"red"}),p=new THREE.Mesh(h,v);p.position=d,u.add(p)}}function o(){requestAnimationFrame(o),a(),s.update(),d.update()}function a(){p.displacement.value+=w.speed,p.color.value=new THREE.Color(w.color),c.render(u,l)}function r(){var e=new THREE.Geometry,t=new THREE.LineBasicMaterial({color:"red",linewidth:1}),n=new XMLHttpRequest;n.open("GET","assets/data/countries.geo.json",!0),n.onreadystatechange=function(){if(4===n.readyState&&200===n.status){for(var o=JSON.parse(n.responseText),a=o.features,r=0;r<a.length;r++){var i=a[r],s=GeoUtils.geoJsonToGeometry(i,m);THREE.GeometryUtils.merge(e,s),console.log(r+" : added "+i.properties.name+" : "+i.geometry.type)}var l=new THREE.Line(e,t,THREE.LinePieces);u.add(l)}},n.send(null)}Detector.webgl||Detector.addGetWebGLMessage();var i,s,l,d,u,c,m,h,v,g,p,E=function(){this.speed=.004,this.color="#121314"},w=new E;e(),o(),r()}();